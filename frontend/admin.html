<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜æ§åˆ¶å° - åŒºå—é“¾ç”µå­æŠ•ç¥¨ç³»ç»Ÿ (ZKP)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; padding: 20px; color: #fff;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { color: #888; font-size: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; padding: 25px; backdrop-filter: blur(10px);
        }
        .card-title {
            font-size: 18px; margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; gap: 10px;
        }
        .card-title .icon { font-size: 24px; }
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .status-item { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center; }
        .status-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .status-value { font-size: 20px; font-weight: bold; }
        .status-value.active { color: #4ade80; }
        .status-value.warning { color: #fbbf24; }
        .btn {
            width: 100%; padding: 12px 20px; border: none; border-radius: 8px;
            font-size: 14px; cursor: pointer; transition: all 0.3s; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:last-child { margin-bottom: 0; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        .input-group input, .input-group textarea {
            width: 100%; padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px;
            background: rgba(255, 255, 255, 0.05); color: white;
            font-size: 14px; font-family: 'Consolas', monospace;
        }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: #667eea; }
        .input-group input::placeholder, .input-group textarea::placeholder { color: #666; }
        .candidate-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: rgba(255, 255, 255, 0.05);
            border-radius: 8px; margin-bottom: 10px;
        }
        .candidate-item .name { font-weight: bold; }
        .candidate-item .votes { color: #4ade80; font-size: 18px; font-weight: bold; }
        .log-container {
            background: #0d1117; border-radius: 10px; padding: 15px;
            max-height: 250px; overflow-y: auto;
            font-family: 'Consolas', monospace; font-size: 12px;
        }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #21262d; }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #666; }
        .log-info { color: #58a6ff; }
        .log-success { color: #4ade80; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }
        .alert { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .alert-info { background: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.3); color: #58a6ff; }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .connection-status { display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; margin-bottom: 20px; }
        .connection-dot { width: 12px; height: 12px; border-radius: 50%; background: #f87171; }
        .connection-dot.connected { background: #4ade80; }
        .connection-info { flex: 1; }
        .connection-info .label { font-size: 12px; color: #888; }
        .connection-info .value { font-size: 14px; font-family: 'Consolas', monospace; }
        .zkp-badge {
            display: inline-block; padding: 3px 8px; border-radius: 12px;
            background: linear-gradient(135deg, #00b09b, #96c93d); color: white;
            font-size: 11px; font-weight: bold; margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç®¡ç†å‘˜æ§åˆ¶å° <span class="zkp-badge">ZKP</span></h1>
            <p id="adminSubtitle">åŒºå—é“¾ç”µå­æŠ•ç¥¨ç³»ç»Ÿ - é›¶çŸ¥è¯†è¯æ˜ç‰ˆ</p>
        </div>

        <div class="connection-status">
            <div class="connection-dot" id="connectionDot"></div>
            <div class="connection-info">
                <div class="label">ç®¡ç†å‘˜è´¦æˆ·</div>
                <div class="value" id="adminAddress">æœªè¿æ¥</div>
            </div>
            <button class="btn btn-primary" id="connectBtn" onclick="connectWallet()" style="width: auto;">è¿æ¥é’±åŒ…</button>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-title"><span class="icon">ğŸ“Š</span>é€‰ä¸¾çŠ¶æ€</div>
                <div class="status-grid">
                    <div class="status-item"><div class="status-label">å½“å‰çŠ¶æ€</div><div class="status-value" id="electionStatus">-</div></div>
                    <div class="status-item"><div class="status-label">å€™é€‰äººæ•°</div><div class="status-value" id="candidateCount">-</div></div>
                    <div class="status-item"><div class="status-label">å·²æ³¨å†Œé€‰æ°‘</div><div class="status-value" id="voterCount">-</div></div>
                    <div class="status-item"><div class="status-label">å·²æŠ•ç¥¨æ•°</div><div class="status-value" id="voteCount">-</div></div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" id="startBtn" onclick="startElection()" disabled>å¯åŠ¨é€‰ä¸¾</button>
                    <button class="btn btn-danger" id="endBtn" onclick="endElection()" disabled>ç»“æŸé€‰ä¸¾</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><span class="icon">ğŸ‘¥</span>é€‰æ°‘ç®¡ç†</div>
                <div class="input-group">
                    <label>é€‰æ°‘åœ°å€</label>
                    <input type="text" id="voterAddress" placeholder="0x..." />
                </div>
                <button class="btn btn-primary" id="registerBtn" onclick="registerVoter()" disabled>æ³¨å†Œé€‰æ°‘</button>
            </div>

            <div class="card">
                <div class="card-title"><span class="icon">ğŸ†</span>å€™é€‰äººç®¡ç†</div>
                <div class="input-group">
                    <label>å€™é€‰äººå§“å</label>
                    <input type="text" id="candidateName" placeholder="è¾“å…¥å€™é€‰äººå§“å" />
                </div>
                <button class="btn btn-primary" id="addCandidateBtn" onclick="addCandidate()" disabled>æ·»åŠ å€™é€‰äºº</button>
                <div id="candidateList" style="margin-top: 15px;"></div>
            </div>

            <div class="card">
                <div class="card-title"><span class="icon">ğŸ”</span>ElGamal å¯†é’¥ç®¡ç†</div>
                <div class="alert alert-info">ç®¡ç†å‘˜éœ€è¦è¾“å…¥ ElGamal ç§é’¥ç”¨äºè§£å¯†æŠ•ç¥¨ç»“æœ</div>
                <div class="input-group">
                    <label>ElGamal ç§é’¥ (sk)</label>
                    <input type="password" id="adminSK" placeholder="è¾“å…¥ ElGamal ç§é’¥ (BigInt)" />
                </div>
                <button class="btn btn-primary" onclick="loadAdminKey()">åŠ è½½å¯†é’¥</button>
                <div id="keyStatus" style="margin-top: 10px; font-size: 12px; color: #888;"></div>
            </div>

            <div class="card">
                <div class="card-title"><span class="icon">ğŸ“</span>ZKP è®¡ç¥¨ç®¡ç†</div>
                <div class="alert alert-info">
                    è®¡ç¥¨æµç¨‹: ç»“æŸé€‰ä¸¾ -> è¯»å–åŠ å¯†é€‰ç¥¨ -> åŒæ€èšåˆ -> è§£å¯† -> ç”Ÿæˆ ZKP3 è¯æ˜ -> ä¸Šä¼ ç»“æœ
                </div>
                <button class="btn btn-warning" id="tallyBtn" onclick="submitTallyWithZKP()" disabled>åŒæ€è®¡ç¥¨ + ç”Ÿæˆ ZKP3 è¯æ˜</button>
                <div id="tallyResults" style="margin-top: 15px;"></div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-title"><span class="icon">ğŸ“‹</span>æ“ä½œæ—¥å¿—</div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry"><span class="log-time">[ç³»ç»Ÿ]</span> <span class="log-info">è¯·è¿æ¥ç®¡ç†å‘˜é’±åŒ…</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/snarkjs@0.7.3/build/snarkjs.min.js"></script>
    <script src="https://unpkg.com/circomlibjs@0.1.7/build/circomlibjs.umd.js"></script>
    <script src="config.js"></script>
    <script src="lib/elgamal.js"></script>
    <script>
        const VOTING_ADDRESS = CONTRACT_CONFIG.VOTING_ADDRESS;
        const VOTER_REGISTRY_ADDRESS = CONTRACT_CONFIG.VOTER_REGISTRY_ADDRESS;

        const VOTING_ABI = [
            "function getElectionInfo() view returns (string, string, uint8, uint256, uint256)",
            "function getCandidate(uint256) view returns (string, uint256)",
            "function addCandidate(string)",
            "function startElection()",
            "function endElection()",
            "function updateTallyResults(uint256[], bytes32, uint256[2], uint256[2][2], uint256[2], uint256[21])",
            "function admin() view returns (address)",
            "function getElgamalPK() view returns (uint256[2])",
            "event EncryptedVoteCast(address indexed voter, bytes32 commitment, uint256[] encryptedVote)"
        ];

        const VOTER_REGISTRY_ABI = [
            "function registerVoter(address)",
            "function isRegistered(address) view returns (bool)",
            "function hasVoted(address) view returns (bool)",
            "function totalVoters() view returns (uint256)",
            "function admin() view returns (address)"
        ];

        let provider, signer, votingContract, voterRegistryContract, currentAccount;
        let candidates = [];
        let elgamal = null;
        let adminSK = null;
        let adminPK = null;
        const STATUS_NAMES = ["å·²åˆ›å»º", "è¿›è¡Œä¸­", "å·²ç»“æŸ", "å·²è®¡ç¥¨"];

        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function loadAdminKey() {
            const skInput = document.getElementById('adminSK').value.trim();
            if (!skInput) {
                addLog('è¯·è¾“å…¥ ElGamal ç§é’¥', 'warning');
                return;
            }
            try {
                adminSK = BigInt(skInput);
                const G = elgamal.getGenerator();
                const derivedPK = elgamal.scalarMul(adminSK, G);
                document.getElementById('keyStatus').textContent =
                    `å¯†é’¥å·²åŠ è½½ (PK.x: ${elgamal.fromF(derivedPK[0]).toString().slice(0, 20)}...)`;
                document.getElementById('keyStatus').style.color = '#4ade80';
                addLog('ElGamal ç§é’¥å·²åŠ è½½', 'success');
            } catch (e) {
                addLog(`å¯†é’¥åŠ è½½å¤±è´¥: ${e.message}`, 'error');
                document.getElementById('keyStatus').textContent = 'å¯†é’¥æ ¼å¼é”™è¯¯';
                document.getElementById('keyStatus').style.color = '#f87171';
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                addLog('è¯·å®‰è£… MetaMaskï¼', 'error');
                return;
            }

            try {
                addLog('æ­£åœ¨è¿æ¥é’±åŒ…...', 'info');
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                currentAccount = accounts[0];

                const network = await provider.getNetwork();
                const expectedChainId = BigInt(CONTRACT_CONFIG.NETWORK.chainId);
                if (network.chainId !== expectedChainId) {
                    addLog(`è¯·åˆ‡æ¢åˆ° ${CONTRACT_CONFIG.NETWORK.name} ç½‘ç»œ`, 'warning');
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CONTRACT_CONFIG.NETWORK.chainIdHex }] });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: CONTRACT_CONFIG.NETWORK.chainIdHex,
                                    chainName: CONTRACT_CONFIG.NETWORK.name,
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: [CONTRACT_CONFIG.NETWORK.rpcUrl || 'https://rpc.sepolia.org'],
                                    blockExplorerUrls: [CONTRACT_CONFIG.NETWORK.explorerUrl || 'https://sepolia.etherscan.io']
                                }]
                            });
                        } else { throw switchError; }
                    }
                    provider = new ethers.BrowserProvider(window.ethereum);
                }

                signer = await provider.getSigner();
                votingContract = new ethers.Contract(VOTING_ADDRESS, VOTING_ABI, signer);
                voterRegistryContract = new ethers.Contract(VOTER_REGISTRY_ADDRESS, VOTER_REGISTRY_ABI, signer);

                const votingAdmin = await votingContract.admin();
                if (votingAdmin.toLowerCase() !== currentAccount.toLowerCase()) {
                    addLog('å½“å‰è´¦æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼', 'warning');
                    addLog(`ç®¡ç†å‘˜åœ°å€: ${votingAdmin}`, 'info');
                }

                // Load ElGamal public key
                try {
                    const pk = await votingContract.getElgamalPK();
                    adminPK = elgamal.pkFromBigInts(pk[0].toString(), pk[1].toString());
                    addLog('å·²åŠ è½½ ElGamal å…¬é’¥', 'success');
                } catch (e) {
                    adminPK = elgamal.pkFromBigInts(CONTRACT_CONFIG.ELGAMAL_PK.x, CONTRACT_CONFIG.ELGAMAL_PK.y);
                    addLog('ä½¿ç”¨é…ç½®ä¸­çš„ ElGamal å…¬é’¥', 'info');
                }

                document.getElementById('connectionDot').classList.add('connected');
                document.getElementById('adminAddress').textContent = currentAccount;
                document.getElementById('connectBtn').textContent = 'å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;

                document.getElementById('adminSubtitle').textContent =
                    `åŒºå—é“¾ç”µå­æŠ•ç¥¨ç³»ç»Ÿ - ${CONTRACT_CONFIG.NETWORK.name} (é›¶çŸ¥è¯†è¯æ˜ç‰ˆ)`;

                // å¼€å‘æ¨¡å¼: è‡ªåŠ¨å¡«å……æµ‹è¯•ç§é’¥
                if (CONTRACT_CONFIG.DEV_ADMIN_SK) {
                    document.getElementById('adminSK').value = CONTRACT_CONFIG.DEV_ADMIN_SK;
                    addLog('æ£€æµ‹åˆ°å¼€å‘æ¨¡å¼ï¼Œå·²è‡ªåŠ¨å¡«å……æµ‹è¯• ElGamal ç§é’¥', 'warning');
                }

                addLog(`å·²è¿æ¥: ${currentAccount.slice(0, 10)}...`, 'success');
                await loadElectionInfo();

                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());

            } catch (error) {
                if (error.code === 4001) {
                    addLog('ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚', 'warning');
                } else {
                    addLog(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        async function loadElectionInfo() {
            try {
                const info = await votingContract.getElectionInfo();
                const status = Number(info[2]);
                const candidateCount = Number(info[3]);
                const totalVotes = Number(info[4]);
                const totalVoters = await voterRegistryContract.totalVoters();

                document.getElementById('electionStatus').textContent = STATUS_NAMES[status];
                document.getElementById('electionStatus').className = 'status-value ' + (status === 1 ? 'active' : status === 0 ? 'warning' : '');
                document.getElementById('candidateCount').textContent = candidateCount;
                document.getElementById('voterCount').textContent = totalVoters.toString();
                document.getElementById('voteCount').textContent = totalVotes;

                document.getElementById('startBtn').disabled = status !== 0;
                document.getElementById('endBtn').disabled = status !== 1;
                document.getElementById('addCandidateBtn').disabled = status !== 0;
                document.getElementById('registerBtn').disabled = false;
                document.getElementById('tallyBtn').disabled = status !== 2;

                candidates = [];
                const candidateList = document.getElementById('candidateList');
                candidateList.innerHTML = '';

                for (let i = 0; i < candidateCount; i++) {
                    const candidate = await votingContract.getCandidate(i);
                    candidates.push({ id: i, name: candidate[0], votes: Number(candidate[1]) });
                    candidateList.innerHTML += `<div class="candidate-item"><span class="name">${candidate[0]}</span><span class="votes">${candidate[1]} ç¥¨</span></div>`;
                }

                addLog('é€‰ä¸¾ä¿¡æ¯å·²åŠ è½½', 'success');
            } catch (error) {
                addLog(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function registerVoter() {
            const address = document.getElementById('voterAddress').value.trim();
            if (!address || !address.startsWith('0x') || address.length !== 42) {
                addLog('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€', 'warning');
                return;
            }

            try {
                const btn = document.getElementById('registerBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> æ³¨å†Œä¸­...';

                const isRegistered = await voterRegistryContract.isRegistered(address);
                if (isRegistered) {
                    addLog('è¯¥åœ°å€å·²æ³¨å†Œ', 'warning');
                    btn.disabled = false;
                    btn.innerHTML = 'æ³¨å†Œé€‰æ°‘';
                    return;
                }

                addLog(`æ­£åœ¨æ³¨å†Œé€‰æ°‘: ${address.slice(0, 10)}...`, 'info');
                const tx = await voterRegistryContract.registerVoter(address);
                addLog('ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                await tx.wait();
                addLog('é€‰æ°‘æ³¨å†ŒæˆåŠŸï¼', 'success');

                document.getElementById('voterAddress').value = '';
                await loadElectionInfo();
                btn.disabled = false;
                btn.innerHTML = 'æ³¨å†Œé€‰æ°‘';

            } catch (error) {
                addLog(`æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
                document.getElementById('registerBtn').disabled = false;
                document.getElementById('registerBtn').innerHTML = 'æ³¨å†Œé€‰æ°‘';
            }
        }

        async function addCandidate() {
            const name = document.getElementById('candidateName').value.trim();
            if (!name) {
                addLog('è¯·è¾“å…¥å€™é€‰äººå§“å', 'warning');
                return;
            }

            try {
                const btn = document.getElementById('addCandidateBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> æ·»åŠ ä¸­...';

                addLog(`æ­£åœ¨æ·»åŠ å€™é€‰äºº: ${name}`, 'info');
                const tx = await votingContract.addCandidate(name);
                addLog('ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                await tx.wait();
                addLog('å€™é€‰äººæ·»åŠ æˆåŠŸï¼', 'success');

                document.getElementById('candidateName').value = '';
                await loadElectionInfo();
                btn.disabled = false;
                btn.innerHTML = 'æ·»åŠ å€™é€‰äºº';

            } catch (error) {
                addLog(`æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('addCandidateBtn').disabled = false;
                document.getElementById('addCandidateBtn').innerHTML = 'æ·»åŠ å€™é€‰äºº';
            }
        }

        async function startElection() {
            try {
                const btn = document.getElementById('startBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> å¯åŠ¨ä¸­...';

                addLog('æ­£åœ¨å¯åŠ¨é€‰ä¸¾...', 'info');
                const tx = await votingContract.startElection();
                addLog('ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                await tx.wait();
                addLog('é€‰ä¸¾å·²å¯åŠ¨ï¼', 'success');
                await loadElectionInfo();

            } catch (error) {
                addLog(`å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').innerHTML = 'å¯åŠ¨é€‰ä¸¾';
            }
        }

        async function endElection() {
            if (!confirm('ç¡®å®šè¦ç»“æŸé€‰ä¸¾å—ï¼Ÿ')) return;

            try {
                const btn = document.getElementById('endBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> ç»“æŸä¸­...';

                addLog('æ­£åœ¨ç»“æŸé€‰ä¸¾...', 'info');
                const tx = await votingContract.endElection();
                addLog('ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                await tx.wait();
                addLog('é€‰ä¸¾å·²ç»“æŸï¼', 'success');
                await loadElectionInfo();

            } catch (error) {
                addLog(`ç»“æŸå¤±è´¥: ${error.message}`, 'error');
                document.getElementById('endBtn').disabled = false;
                document.getElementById('endBtn').innerHTML = 'ç»“æŸé€‰ä¸¾';
            }
        }

        async function submitTallyWithZKP() {
            if (!adminSK) {
                addLog('è¯·å…ˆåŠ è½½ ElGamal ç§é’¥', 'error');
                return;
            }

            try {
                const btn = document.getElementById('tallyBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> è¯»å–åŠ å¯†é€‰ç¥¨...';
                const numCandidates = candidates.length;

                // 1. Read all encrypted votes from event logs
                addLog('æ­£åœ¨è¯»å–é“¾ä¸ŠåŠ å¯†é€‰ç¥¨äº‹ä»¶...', 'info');
                const filter = votingContract.filters.EncryptedVoteCast();
                const events = await votingContract.queryFilter(filter);
                addLog(`æ‰¾åˆ° ${events.length} å¼ åŠ å¯†é€‰ç¥¨`, 'info');

                if (events.length === 0) {
                    addLog('æ²¡æœ‰æŠ•ç¥¨è®°å½•', 'warning');
                    btn.disabled = false;
                    btn.innerHTML = 'åŒæ€è®¡ç¥¨ + ç”Ÿæˆ ZKP3 è¯æ˜';
                    return;
                }

                // 2. Parse encrypted votes and perform homomorphic aggregation
                addLog('æ­£åœ¨æ‰§è¡ŒåŒæ€èšåˆ...', 'info');
                btn.innerHTML = '<span class="loading"></span> åŒæ€èšåˆä¸­...';

                const allVotes = events.map(event => {
                    const encData = event.args.encryptedVote;
                    return elgamal.uint256ArrayToCiphertexts(
                        encData.map(x => BigInt(x.toString())),
                        numCandidates
                    );
                });

                const aggregated = elgamal.aggregateVotes(allVotes, numCandidates);
                addLog('åŒæ€èšåˆå®Œæˆ', 'success');

                // 3. Decrypt aggregated ciphertexts
                addLog('æ­£åœ¨è§£å¯†æŠ•ç¥¨ç»“æœ...', 'info');
                btn.innerHTML = '<span class="loading"></span> è§£å¯†ä¸­...';

                const results = [];
                const resultPoints = [];
                for (let j = 0; j < numCandidates; j++) {
                    const mG = elgamal.decryptToPoint(aggregated[j], adminSK);
                    resultPoints.push(mG);
                    const count = elgamal.solveDLog(mG, events.length + 100);
                    results.push(count);
                    addLog(`${candidates[j].name}: ${count} ç¥¨`, 'info');
                }

                // Display results
                const tallyResultsDiv = document.getElementById('tallyResults');
                tallyResultsDiv.innerHTML = results.map((r, i) =>
                    `<div class="candidate-item"><span class="name">${candidates[i].name}</span><span class="votes">${r} ç¥¨</span></div>`
                ).join('');

                // 4. Generate ZKP3 tally proof
                addLog('æ­£åœ¨ç”Ÿæˆ ZKP3 è®¡ç¥¨è¯æ˜ (Groth16)...', 'info');
                btn.innerHTML = '<span class="loading"></span> ZKP3 è¯æ˜ç”Ÿæˆä¸­...';

                const G = elgamal.getGenerator();
                const derivedPK = elgamal.scalarMul(adminSK, G);
                const tallyWitness = elgamal.prepareTallyWitness(
                    adminSK, derivedPK, aggregated, resultPoints, events.length
                );

                const { proof, publicSignals } = await snarkjs.groth16.fullProve(
                    tallyWitness,
                    CONTRACT_CONFIG.ZKP.TALLY_PROOF_WASM,
                    CONTRACT_CONFIG.ZKP.TALLY_PROOF_ZKEY
                );
                addLog('ZKP3 è¯æ˜ç”ŸæˆæˆåŠŸ!', 'success');

                // 5. Convert proof to Solidity calldata
                const calldataStr = await snarkjs.groth16.exportSolidityCallData(proof, publicSignals);
                const calldata = JSON.parse(`[${calldataStr}]`);

                const pA = calldata[0];
                const pB = calldata[1];
                const pC = calldata[2];
                const pubSignals21 = calldata[3]; // 21 public signals

                // 6. Compute merkle root
                const merkleRoot = ethers.keccak256(ethers.toUtf8Bytes(JSON.stringify(results)));

                // 7. Submit to contract
                addLog('æ­£åœ¨æäº¤è®¡ç¥¨ç»“æœ (å« ZKP3 è¯æ˜)...', 'info');
                btn.innerHTML = '<span class="loading"></span> æäº¤ä¸­...';

                const tx = await votingContract.updateTallyResults(
                    results, merkleRoot, pA, pB, pC, pubSignals21
                );
                addLog('äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                await tx.wait();

                addLog('è®¡ç¥¨ç»“æœå·²ä¸Šä¼ å¹¶é€šè¿‡ ZKP éªŒè¯!', 'success');
                await loadElectionInfo();

            } catch (error) {
                addLog(`è®¡ç¥¨å¤±è´¥: ${error.message}`, 'error');
                console.error('Tally error:', error);
                document.getElementById('tallyBtn').disabled = false;
                document.getElementById('tallyBtn').innerHTML = 'åŒæ€è®¡ç¥¨ + ç”Ÿæˆ ZKP3 è¯æ˜';
            }
        }

        window.addEventListener('load', async () => {
            addLog('ç®¡ç†å‘˜æ§åˆ¶å°å·²åŠ è½½ (ZKP ç‰ˆæœ¬)', 'info');

            // Initialize ElGamal library
            try {
                elgamal = await ElGamalLib.init();
                addLog('ZKP åº“åˆå§‹åŒ–æˆåŠŸ', 'success');
            } catch (e) {
                addLog(`ZKP åº“åˆå§‹åŒ–å¤±è´¥: ${e.message}`, 'error');
            }

            if (typeof window.ethereum !== 'undefined') {
                addLog('æ£€æµ‹åˆ° MetaMask', 'info');
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    addLog('å‘ç°å·²æˆæƒè´¦æˆ·ï¼Œè‡ªåŠ¨è¿æ¥...', 'info');
                    connectWallet();
                } else {
                    addLog('è¯·ç‚¹å‡»è¿æ¥é’±åŒ…', 'info');
                }
            } else {
                addLog('æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å®‰è£…: https://metamask.io', 'warning');
            }
        });
    </script>
</body>
</html>

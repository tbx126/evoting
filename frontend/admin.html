<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员控制台 - 区块链电子投票系统 (ZKP)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&family=Fira+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #0F172A;
            --color-secondary: #1E293B;
            --color-cta: #22C55E;
            --color-background: #020617;
            --color-text: #F8FAFC;
            --color-muted: #94A3B8;
            --color-border: rgba(255,255,255,0.08);
            --color-surface: rgba(255,255,255,0.04);
            --color-surface-hover: rgba(255,255,255,0.07);
            --color-danger: #EF4444;
            --color-warning: #F59E0B;
            --color-info: #3B82F6;
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Fira Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.4;
        }
        /* --- Navbar --- */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 56px;
            background: var(--color-primary);
            border-bottom: 1px solid var(--color-border);
            z-index: 100;
            display: flex;
            align-items: center;
        }
        .nav-content {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
        }
        .nav-brand svg { flex-shrink: 0; }
        .zkp-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 20px;
            background: var(--color-cta);
            color: #fff;
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            font-weight: 600;
        }
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .subtitle {
            font-size: 13px;
            color: var(--color-muted);
            display: none;
        }
        .nav-link {
            color: var(--color-muted);
            text-decoration: none;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
            transition: all 200ms ease;
            cursor: pointer;
        }
        .nav-link:hover {
            color: var(--color-text);
            border-color: rgba(255,255,255,0.2);
            background: var(--color-surface);
        }
        .btn-sm {
            padding: 6px 14px;
            width: auto;
            border: none;
            border-radius: 8px;
            background: var(--color-cta);
            color: #fff;
            font-family: 'Fira Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-sm:hover { opacity: 0.9; }
        .btn-sm:disabled { background: #334155; color: #64748B; cursor: not-allowed; }
        .btn-sm.connected {
            background: rgba(34,197,94,0.15);
            color: var(--color-cta);
            border: 1px solid rgba(34,197,94,0.3);
            font-family: 'Fira Code', monospace;
            font-size: 12px;
        }
        .conn-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-danger);
            display: inline-block;
        }
        .conn-dot.connected { background: var(--color-cta); }
        /* --- Container --- */
        .app-layout {
            display: flex;
            margin-top: 56px;
            min-height: calc(100vh - 56px);
        }
        .container {
            flex: 1;
            min-width: 0;
            padding: 16px 24px 24px;
            overflow-y: auto;
            max-height: calc(100vh - 56px);
        }
        /* --- Stats Grid --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .stat-card {
            background: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 12px 16px;
            text-align: center;
            transition: transform 200ms ease, box-shadow 200ms ease;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .stat-label {
            font-size: 11px;
            color: var(--color-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .stat-val {
            font-family: 'Fira Code', monospace;
            font-size: 20px;
            font-weight: 600;
        }
        .stat-val.active { color: var(--color-cta); }
        .stat-val.warning { color: var(--color-warning); }
        /* --- Section --- */
        .section {
            background: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 20px;
        }
        .section-title {
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text);
        }
        .section-title svg { color: var(--color-cta); }
        .grid-2col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        /* --- Inputs --- */
        .input-group { margin-bottom: 10px; }
        .input-group label {
            display: block;
            font-size: 12px;
            color: var(--color-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            font-family: 'Fira Code', monospace;
            transition: border-color 200ms ease;
        }
        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--color-cta);
            box-shadow: 0 0 0 3px rgba(34,197,94,0.15);
        }
        .input-group input::placeholder, .input-group textarea::placeholder { color: #475569; }
        /* --- Buttons --- */
        .btn {
            width: 100%;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Fira Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms ease;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:last-child { margin-bottom: 0; }
        .btn-cta { background: var(--color-cta); color: #fff; }
        .btn-cta:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-success { background: #059669; color: #fff; }
        .btn-success:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-danger { background: var(--color-danger); color: #fff; }
        .btn-danger:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-warning { background: var(--color-warning); color: #000; }
        .btn-warning:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        /* --- Alerts --- */
        .alert {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert svg { flex-shrink: 0; }
        .alert-info {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.25);
            color: var(--color-info);
        }
        /* --- Tally Stepper --- */
        .tally-stepper { display: flex; flex-direction: column; gap: 0; }
        .tally-step {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 10px 0; border-bottom: 1px solid var(--color-border);
        }
        .tally-step:last-child { border-bottom: none; }
        .step-indicator {
            flex-shrink: 0; width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Fira Code', monospace; font-size: 12px; font-weight: 700;
            border: 2px solid var(--color-border); color: var(--color-muted);
            background: transparent; transition: all 300ms ease;
        }
        .step-indicator.running { border-color: var(--color-warning); color: var(--color-warning); }
        .step-indicator.complete { border-color: var(--color-cta); background: var(--color-cta); color: #fff; }
        .step-indicator.error { border-color: var(--color-danger); background: var(--color-danger); color: #fff; }
        .step-body { flex: 1; min-width: 0; }
        .step-title {
            font-family: 'Fira Code', monospace; font-size: 13px;
            font-weight: 600; color: var(--color-text); margin-bottom: 4px;
        }
        .step-title.muted { color: var(--color-muted); }
        .step-detail {
            font-family: 'Fira Code', monospace; font-size: 11px;
            color: var(--color-muted); margin-bottom: 6px; word-break: break-all;
        }
        .step-detail .mono-data { color: var(--color-info); }
        .step-detail .tx-link { color: var(--color-info); text-decoration: none; }
        .step-detail .tx-link:hover { text-decoration: underline; }
        .step-btn {
            padding: 6px 14px; border: none; border-radius: 6px;
            font-family: 'Fira Sans', sans-serif; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 200ms ease;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .step-btn:hover { opacity: 0.9; }
        .step-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .step-btn-warning { background: var(--color-warning); color: #000; }
        .step-btn-cta { background: var(--color-cta); color: #fff; }
        /* --- Candidate Items --- */
        .candidate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--color-surface);
            border-radius: 6px;
            margin-bottom: 4px;
        }
        .candidate-item .name { font-weight: 500; }
        .candidate-item .votes {
            color: var(--color-cta);
            font-family: 'Fira Code', monospace;
            font-weight: 600;
        }
        /* --- Loading --- */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* --- Log Sidebar --- */
        .log-sidebar {
            width: 360px;
            flex-shrink: 0;
            background: var(--color-primary);
            border-left: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 56px);
        }
        .log-sidebar-header {
            padding: 12px 16px;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .log-sidebar-header svg { color: var(--color-cta); }
        .log-body {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        .log-entry {
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            padding: 4px 16px;
            border-bottom: 1px solid var(--color-border);
            line-height: 1.5;
            word-break: break-all;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #64748B; }
        .log-info { color: var(--color-info); }
        .log-success { color: var(--color-cta); }
        .log-error { color: var(--color-danger); }
        .log-warning { color: var(--color-warning); }
        /* --- Responsive --- */
        @media (min-width: 769px) {
            .subtitle { display: inline; }
        }
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-2col { grid-template-columns: 1fr; }
            .app-layout { flex-direction: column; }
            .log-sidebar { width: 100%; max-height: 200px; border-left: none; border-top: 1px solid var(--color-border); }
            .container { max-height: none; }
        }
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .nav-content { padding: 0 16px; }
            .subtitle { display: none; }
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { transition: none !important; animation: none !important; }
        }
        /* --- Focus States --- */
        .btn:focus-visible, .btn-sm:focus-visible, .nav-link:focus-visible, .input-group input:focus-visible, .input-group textarea:focus-visible {
            outline: 2px solid var(--color-cta);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                管理员控制台
                <span class="zkp-badge">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    ZKP
                </span>
            </div>
            <div class="nav-actions">
                <span class="subtitle" id="adminSubtitle">区块链电子投票系统 - 零知识证明版</span>
                <a href="voting-app.html" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>
                    选民投票页
                </a>
                <button id="connectBtn" onclick="connectWallet()" class="btn-sm">
                    <span class="conn-dot" id="connectionDot"></span>
                    连接钱包
                </button>
            </div>
        </div>
    </nav>
    <div class="app-layout">
    <!-- Main Content -->
    <main class="container">
        <!-- Stats Row -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">当前状态</div>
                <div class="stat-val" id="electionStatus">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">候选人数</div>
                <div class="stat-val" id="candidateCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">已注册选民</div>
                <div class="stat-val" id="voterCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">已投票数</div>
                <div class="stat-val" id="voteCount">-</div>
            </div>
        </div>

        <!-- Management 2x2 Grid -->
        <div class="grid-2col">
            <!-- Top-left: 选举控制 -->
            <div class="section">
                <div class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    选举控制
                </div>
                <button class="btn btn-success" id="startBtn" onclick="startElection()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    启动选举
                </button>
                <button class="btn btn-danger" id="endBtn" onclick="endElection()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                    结束选举
                </button>
            </div>
            <!-- Top-right: 选民管理 -->
            <div class="section">
                <div class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                    选民管理
                </div>
                <div class="input-group">
                    <label>选民地址 (每行一个，支持批量)</label>
                    <textarea id="voterAddress" rows="2" placeholder="0x...&#10;0x..." style="resize:vertical;"></textarea>
                </div>
                <button class="btn btn-cta" id="registerBtn" onclick="registerVoters()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>
                    注册选民
                </button>
            </div>
            <!-- Bottom-left: 候选人管理 -->
            <div class="section">
                <div class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    候选人管理
                </div>
                <div class="input-group">
                    <label>候选人 0 姓名</label>
                    <input type="text" id="candidateName0" placeholder="候选人 0（如：张三）" />
                </div>
                <div class="input-group">
                    <label>候选人 1 姓名</label>
                    <input type="text" id="candidateName1" placeholder="候选人 1（如：李四）" onkeydown="if(event.key==='Enter')addCandidates()" />
                </div>
                <button class="btn btn-cta" id="addCandidateBtn" onclick="addCandidates()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    添加两位候选人
                </button>
                <div id="candidateList" style="margin-top:8px;"></div>
            </div>
            <!-- Bottom-right: ElGamal 密钥管理 -->
            <div class="section">
                <div class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    ElGamal 密钥管理
                </div>
                <div class="alert alert-info">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    管理员需要输入 ElGamal 私钥用于解密投票结果
                </div>
                <div class="input-group">
                    <label>ElGamal 私钥 (sk)</label>
                    <input type="password" id="adminSK" placeholder="输入 ElGamal 私钥 (BigInt)" onkeydown="if(event.key==='Enter')loadAdminKey()" />
                </div>
                <button class="btn btn-cta" onclick="loadAdminKey()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                    加载密钥
                </button>
                <div id="keyStatus" style="margin-top:8px;font-size:12px;font-family:'Fira Code',monospace;color:var(--color-muted);"></div>
            </div>
        </div>
        <!-- ZKP Tally Section -->
        <div class="section" id="tallySection">
            <div class="section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                ZKP 计票管理 (分步操作)
            </div>
            <div class="alert alert-info">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                依次执行每个步骤。每步完成后才能执行下一步，失败可重试。
            </div>
            <div class="tally-stepper" id="tallyStepper">
                <div class="tally-step"><div class="step-indicator" id="stepInd1">1</div><div class="step-body">
                    <div class="step-title muted" id="stepTitle1">读取加密选票</div>
                    <div class="step-detail" id="stepDetail1">从链上读取 EncryptedVoteCast 事件</div>
                    <button class="step-btn step-btn-warning" id="stepBtn1" onclick="tallyStep1_readVotes()" disabled>读取选票</button>
                </div></div>
                <div class="tally-step"><div class="step-indicator" id="stepInd2">2</div><div class="step-body">
                    <div class="step-title muted" id="stepTitle2">同态聚合</div>
                    <div class="step-detail" id="stepDetail2">将所有加密选票按候选人列聚合</div>
                    <button class="step-btn step-btn-warning" id="stepBtn2" onclick="tallyStep2_aggregate()" disabled>执行聚合</button>
                </div></div>
                <div class="tally-step"><div class="step-indicator" id="stepInd3">3</div><div class="step-body">
                    <div class="step-title muted" id="stepTitle3">解密投票结果</div>
                    <div class="step-detail" id="stepDetail3">使用 ElGamal 私钥解密聚合密文</div>
                    <button class="step-btn step-btn-warning" id="stepBtn3" onclick="tallyStep3_decrypt()" disabled>解密</button>
                </div></div>
                <div class="tally-step"><div class="step-indicator" id="stepInd4">4</div><div class="step-body">
                    <div class="step-title muted" id="stepTitle4">生成 ZKP3 证明</div>
                    <div class="step-detail" id="stepDetail4">Groth16 证明解密过程正确 (约 3-10 秒)</div>
                    <button class="step-btn step-btn-warning" id="stepBtn4" onclick="tallyStep4_generateZKP()" disabled>生成证明</button>
                </div></div>
                <div class="tally-step"><div class="step-indicator" id="stepInd5">5</div><div class="step-body">
                    <div class="step-title muted" id="stepTitle5">构建 Merkle 审计树</div>
                    <div class="step-detail" id="stepDetail5">从链上承诺构建 Merkle 树</div>
                    <button class="step-btn step-btn-warning" id="stepBtn5" onclick="tallyStep5_buildMerkle()" disabled>构建</button>
                </div></div>
                <div class="tally-step"><div class="step-indicator" id="stepInd6">6</div><div class="step-body">
                    <div class="step-title muted" id="stepTitle6">提交计票结果上链</div>
                    <div class="step-detail" id="stepDetail6">调用 updateTallyResults 并等待确认</div>
                    <button class="step-btn step-btn-cta" id="stepBtn6" onclick="tallyStep6_submitChain()" disabled>提交上链</button>
                </div></div>
                <div class="tally-step"><div class="step-indicator" id="stepInd7">7</div><div class="step-body">
                    <div class="step-title muted" id="stepTitle7">导出审计包</div>
                    <div class="step-detail" id="stepDetail7">生成并下载 JSON 审计包</div>
                    <button class="step-btn step-btn-cta" id="stepBtn7" onclick="tallyStep7_exportAudit()" disabled>导出</button>
                </div></div>
            </div>
            <div id="tallyResults" style="margin-top:12px;"></div>
        </div>
    </main>

    <!-- Log Sidebar -->
    <aside class="log-sidebar" id="logPanel">
        <div class="log-sidebar-header">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
            操作日志
        </div>
        <div class="log-body" id="logBody"></div>
    </aside>
    </div>

    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/snarkjs@0.7.3/build/snarkjs.min.js"></script>
    <script src="lib/circomlibjs.bundle.js"></script>
    <script src="config.js"></script>
    <script src="lib/elgamal.js"></script>
    <script src="lib/audit.js"></script>
    <script>
        const VOTING_ADDRESS = CONTRACT_CONFIG.VOTING_ADDRESS;

        const VOTING_ABI = [
            "function getElectionInfo() view returns (string, string, uint8, uint256, uint256)",
            "function getCandidate(uint256) view returns (string, uint256)",
            "function addCandidate(string)",
            "function addCandidates(string, string)",
            "function startElection()",
            "function endElection()",
            "function updateTallyResults(uint256[], bytes32, uint256[2], uint256[2][2], uint256[2], uint256[15])",
            "function admin() view returns (address)",
            "function getElgamalPK() view returns (uint256[2])",
            "function registerVoter(address)",
            "function registerVotersBatch(address[])",
            "function isRegistered(address) view returns (bool)",
            "function totalVoters() view returns (uint256)",
            "event EncryptedVoteCast(address indexed voter, bytes32 commitment, uint256[] encryptedVote)"
        ];

        let provider, signer, votingContract, currentAccount;
        let candidates = [];
        let elgamal = null;
        let adminSK = null;
        let adminPK = null;
        let latestAuditBundle = null;
        const STATUS_NAMES = ["已创建", "进行中", "已结束", "已计票"];

        // --- Tally stepper state ---
        const tallyState = {
            events: null, numVotes: 0,
            allVotes: null, aggregated: null,
            resultPoints: null, results: null,
            proof: null, publicSignals: null,
            pA: null, pB: null, pC: null, pubSignals15: null,
            auditBundle: null, merkleRoot: null,
            tallyTxHash: null, currentStep: 0,
        };

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function addLog(message, type = 'info') {
            const logBody = document.getElementById('logBody');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${escapeHtml(message)}</span>`;
            logBody.appendChild(entry);
            logBody.scrollTop = logBody.scrollHeight;
        }

        function addLogHtml(html, type = 'info') {
            const logBody = document.getElementById('logBody');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${html}</span>`;
            logBody.appendChild(entry);
            logBody.scrollTop = logBody.scrollHeight;
        }

        function setStepState(n, state) {
            const ind = document.getElementById(`stepInd${n}`);
            const title = document.getElementById(`stepTitle${n}`);
            const btn = document.getElementById(`stepBtn${n}`);
            ind.className = `step-indicator ${state}`;
            if (state === 'running') ind.innerHTML = '<span class="loading" style="width:14px;height:14px;border-width:2px;"></span>';
            else if (state === 'complete') ind.textContent = '\u2713';
            else if (state === 'error') ind.textContent = '!';
            else ind.textContent = n;
            title.className = state === 'pending' ? 'step-title muted' : 'step-title';
            if (state === 'running') btn.disabled = true;
        }
        function setStepDetail(n, html) { document.getElementById(`stepDetail${n}`).innerHTML = html; }
        function enableStep(n) {
            if (n > 7) return;
            document.getElementById(`stepBtn${n}`).disabled = false;
            document.getElementById(`stepTitle${n}`).className = 'step-title';
        }
        function fmtMs(ms) { return ms < 1000 ? `${Math.round(ms)}ms` : `${(ms/1000).toFixed(1)}s`; }
        function txHashLink(hash) {
            const short = hash.slice(0,10) + '...' + hash.slice(-8);
            const url = CONTRACT_CONFIG.NETWORK.explorerUrl;
            return url ? `<a class="tx-link" href="${url}/tx/${hash}" target="_blank">${short}</a>` : `<span class="mono-data">${short}</span>`;
        }

        function downloadJsonFile(filename, payload) {
            const json = JSON.stringify(payload, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = filename;
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
            URL.revokeObjectURL(url);
        }

        function downloadLatestAuditBundle() {
            if (!latestAuditBundle) {
                addLog('暂无审计包可导出，请先完成计票', 'warning');
                return;
            }
            const shortAddr = VOTING_ADDRESS.slice(2, 10).toLowerCase();
            const fileName = `audit_bundle_${latestAuditBundle.chainId}_${shortAddr}.json`;
            downloadJsonFile(fileName, latestAuditBundle);
            addLog(`审计包已导出: ${fileName}`, 'success');
        }

        function loadAdminKey() {
            const skInput = document.getElementById('adminSK').value.trim();
            if (!skInput) { addLog('请输入 ElGamal 私钥', 'warning'); return; }
            try {
                adminSK = BigInt(skInput);
                const G = elgamal.getGenerator();
                const derivedPK = elgamal.scalarMul(adminSK, G);
                document.getElementById('keyStatus').textContent =
                    `密钥已加载 (PK.x: ${elgamal.fromF(derivedPK[0]).toString().slice(0, 20)}...)`;
                document.getElementById('keyStatus').style.color = 'var(--color-cta)';
                addLog('ElGamal 私钥已加载', 'success');
            } catch (e) {
                addLog(`密钥加载失败: ${e.message}`, 'error');
                document.getElementById('keyStatus').textContent = '密钥格式错误';
                document.getElementById('keyStatus').style.color = 'var(--color-danger)';
            }
        }
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                addLog('请安装 MetaMask！', 'error'); return;
            }
            try {
                addLog('正在连接钱包...', 'info');
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                currentAccount = accounts[0];

                const network = await provider.getNetwork();
                const expectedChainId = BigInt(CONTRACT_CONFIG.NETWORK.chainId);
                if (network.chainId !== expectedChainId) {
                    addLog(`请切换到 ${CONTRACT_CONFIG.NETWORK.name} 网络`, 'warning');
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CONTRACT_CONFIG.NETWORK.chainIdHex }] });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{ chainId: CONTRACT_CONFIG.NETWORK.chainIdHex, chainName: CONTRACT_CONFIG.NETWORK.name,
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: [CONTRACT_CONFIG.NETWORK.rpcUrl || 'https://rpc.sepolia.org'],
                                    blockExplorerUrls: [CONTRACT_CONFIG.NETWORK.explorerUrl || 'https://sepolia.etherscan.io'] }]
                            });
                        } else { throw switchError; }
                    }
                    provider = new ethers.BrowserProvider(window.ethereum);
                }

                signer = await provider.getSigner();
                votingContract = new ethers.Contract(VOTING_ADDRESS, VOTING_ABI, signer);

                const cachedElectionId = AuditLib.electionKey(CONTRACT_CONFIG.NETWORK.chainId, VOTING_ADDRESS);
                const cachedBundle = localStorage.getItem('audit_bundle_' + cachedElectionId);
                if (cachedBundle) {
                    latestAuditBundle = JSON.parse(cachedBundle);
                    addLog('已加载缓存的审计包', 'info');
                }

                const votingAdmin = await votingContract.admin();
                if (votingAdmin.toLowerCase() !== currentAccount.toLowerCase()) {
                    addLog('当前账户不是管理员！', 'warning');
                    addLog(`管理员地址: ${votingAdmin}`, 'info');
                }

                try {
                    const pk = await votingContract.getElgamalPK();
                    adminPK = elgamal.pkFromBigInts(pk[0].toString(), pk[1].toString());
                    addLog('已加载 ElGamal 公钥', 'success');
                } catch (e) {
                    adminPK = elgamal.pkFromBigInts(CONTRACT_CONFIG.ELGAMAL_PK.x, CONTRACT_CONFIG.ELGAMAL_PK.y);
                    addLog('使用配置中的 ElGamal 公钥', 'info');
                }

                document.getElementById('connectionDot').classList.add('connected');
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.innerHTML = `<span class="conn-dot connected"></span> 已连接`;
                connectBtn.classList.add('connected');
                connectBtn.disabled = true;
                document.getElementById('adminSubtitle').textContent =
                    `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)} | ${CONTRACT_CONFIG.NETWORK.name}`;

                if (CONTRACT_CONFIG.DEV_ADMIN_SK) {
                    document.getElementById('adminSK').value = CONTRACT_CONFIG.DEV_ADMIN_SK;
                    addLog('检测到开发模式，已自动填充测试 ElGamal 私钥', 'warning');
                }

                addLog(`已连接: ${currentAccount.slice(0, 10)}...`, 'success');
                await loadElectionInfo();
                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            } catch (error) {
                if (error.code === 4001) { addLog('用户拒绝了连接请求', 'warning'); }
                else { addLog(`连接失败: ${error.message}`, 'error'); }
            }
        }
        async function loadElectionInfo() {
            try {
                const info = await votingContract.getElectionInfo();
                const status = Number(info[2]);
                const candidateCount = Number(info[3]);
                const totalVotes = Number(info[4]);
                const totalVoters = await votingContract.totalVoters();

                const statusEl = document.getElementById('electionStatus');
                statusEl.textContent = STATUS_NAMES[status];
                statusEl.className = 'stat-val' + (status === 1 ? ' active' : status === 0 ? ' warning' : '');
                document.getElementById('candidateCount').textContent = candidateCount;
                document.getElementById('voterCount').textContent = totalVoters.toString();
                document.getElementById('voteCount').textContent = totalVotes;

                document.getElementById('startBtn').disabled = status !== 0;
                document.getElementById('endBtn').disabled = status !== 1;
                document.getElementById('addCandidateBtn').disabled = status !== 0;
                document.getElementById('registerBtn').disabled = false;
                // Enable stepper Step 1 when election is ended, or mark all complete if tallied
                if (document.getElementById('stepBtn1')) {
                    if (status === 2 && tallyState.currentStep === 0) enableStep(1);
                    else if (status === 3) { for (let s = 1; s <= 7; s++) setStepState(s, 'complete'); }
                }

                candidates = [];
                const candidateList = document.getElementById('candidateList');
                candidateList.innerHTML = '';
                for (let i = 0; i < candidateCount; i++) {
                    const candidate = await votingContract.getCandidate(i);
                    candidates.push({ id: i, name: candidate[0], votes: Number(candidate[1]) });
                    const item = document.createElement('div');
                    item.className = 'candidate-item';
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'name';
                    nameSpan.textContent = candidate[0];
                    const votesSpan = document.createElement('span');
                    votesSpan.className = 'votes';
                    votesSpan.textContent = `${candidate[1]} 票`;
                    item.appendChild(nameSpan);
                    item.appendChild(votesSpan);
                    candidateList.appendChild(item);
                }
                addLog('选举信息已加载', 'success');
            } catch (error) {
                addLog(`加载失败: ${error.message}`, 'error');
            }
        }

        async function registerVoters() {
            const raw = document.getElementById('voterAddress').value.trim();
            if (!raw) { addLog('请输入选民地址', 'warning'); return; }

            const addresses = raw.split(/[\n,;]+/).map(a => a.trim()).filter(a => a.startsWith('0x') && a.length === 42);
            if (addresses.length === 0) { addLog('未找到有效的以太坊地址', 'warning'); return; }

            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 注册中...';

            try {
                if (addresses.length === 1) {
                    const addr = addresses[0];
                    const isRegistered = await votingContract.isRegistered(addr);
                    if (isRegistered) { addLog(`${addr.slice(0,10)}... 已注册`, 'warning'); }
                    else {
                        addLog(`正在注册选民: ${addr.slice(0, 10)}...`, 'info');
                        const tx = await votingContract.registerVoter(addr);
                        addLog('等待交易确认...', 'info');
                        await tx.wait();
                        addLog('选民注册成功！', 'success');
                    }
                } else {
                    addLog(`批量注册 ${addresses.length} 个选民...`, 'info');
                    const tx = await votingContract.registerVotersBatch(addresses);
                    addLog('等待交易确认...', 'info');
                    await tx.wait();
                    addLog(`${addresses.length} 个选民注册成功！`, 'success');
                }
                document.getElementById('voterAddress').value = '';
                await loadElectionInfo();
            } catch (error) {
                addLog(`注册失败: ${error.message}`, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '注册选民';
        }
        async function addCandidates() {
            const name0 = document.getElementById('candidateName0').value.trim();
            const name1 = document.getElementById('candidateName1').value.trim();
            if (!name0 || !name1) { addLog('请输入两位候选人姓名', 'warning'); return; }
            const btn = document.getElementById('addCandidateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 添加中...';
            try {
                addLog(`正在添加候选人: ${name0}, ${name1}`, 'info');
                const tx = await votingContract.addCandidates(name0, name1);
                addLog('等待交易确认...', 'info');
                await tx.wait();
                addLog('两位候选人添加成功！(1 笔交易)', 'success');
                document.getElementById('candidateName0').value = '';
                document.getElementById('candidateName1').value = '';
                await loadElectionInfo();
            } catch (error) {
                addLog(`添加失败: ${error.message}`, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '添加两位候选人';
        }

        async function startElection() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 启动中...';
            try {
                addLog('正在启动选举...', 'info');
                const tx = await votingContract.startElection();
                addLog('等待交易确认...', 'info');
                await tx.wait();
                addLog('选举已启动！', 'success');
                await loadElectionInfo();
            } catch (error) {
                addLog(`启动失败: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '启动选举';
            }
        }

        async function endElection() {
            if (!confirm('确定要结束选举吗？')) return;
            const btn = document.getElementById('endBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 结束中...';
            try {
                addLog('正在结束选举...', 'info');
                const tx = await votingContract.endElection();
                addLog('等待交易确认...', 'info');
                await tx.wait();
                addLog('选举已结束！', 'success');
                await loadElectionInfo();
            } catch (error) {
                addLog(`结束失败: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '结束选举';
            }
        }
        // ===== Tally Step Functions =====

        async function tallyStep1_readVotes() {
            if (!adminSK) { addLog('请先加载 ElGamal 私钥', 'error'); return; }
            setStepState(1, 'running');
            const t0 = performance.now();
            try {
                addLog('[Step 1] 正在读取链上加密选票事件...', 'info');
                const filter = votingContract.filters.EncryptedVoteCast();
                const events = await votingContract.queryFilter(filter);
                if (events.length === 0) {
                    addLog('[Step 1] 没有投票记录', 'warning');
                    setStepState(1, 'error');
                    setStepDetail(1, '未找到任何投票事件');
                    return;
                }
                tallyState.events = events;
                tallyState.numVotes = events.length;
                events.forEach((ev, i) => {
                    addLogHtml(`  #${i}: 区块 ${ev.blockNumber} | ${txHashLink(ev.transactionHash)}`, 'info');
                });
                const ms = fmtMs(performance.now() - t0);
                setStepDetail(1, `找到 <span class="mono-data">${events.length}</span> 张选票 (${ms})`);
                setStepState(1, 'complete');
                tallyState.currentStep = 1;
                enableStep(2);
                addLog(`[Step 1] 完成: ${events.length} 张选票, 耗时 ${ms}`, 'success');
            } catch (e) {
                setStepState(1, 'error');
                setStepDetail(1, `错误: ${escapeHtml(e.message)}`);
                addLog(`[Step 1] 失败: ${e.message}`, 'error');
            }
        }

        async function tallyStep2_aggregate() {
            if (tallyState.currentStep < 1) return;
            setStepState(2, 'running');
            const t0 = performance.now();
            try {
                const n = candidates.length;
                addLog(`[Step 2] 同态聚合 (${tallyState.numVotes} 票, ${n} 候选人)...`, 'info');
                const allVotes = tallyState.events.map(ev => {
                    const enc = ev.args.encryptedVote;
                    return elgamal.uint256ArrayToCiphertexts(enc.map(x => BigInt(x.toString())), n);
                });
                const aggregated = elgamal.aggregateVotes(allVotes, n);
                tallyState.allVotes = allVotes;
                tallyState.aggregated = aggregated;
                const ms = fmtMs(performance.now() - t0);
                setStepDetail(2, `聚合完成: ${n} 组密文 (${ms})`);
                setStepState(2, 'complete');
                tallyState.currentStep = 2;
                enableStep(3);
                addLog(`[Step 2] 同态聚合完成, 耗时 ${ms}`, 'success');
            } catch (e) {
                setStepState(2, 'error');
                setStepDetail(2, `错误: ${escapeHtml(e.message)}`);
                addLog(`[Step 2] 失败: ${e.message}`, 'error');
            }
        }

        async function tallyStep3_decrypt() {
            if (tallyState.currentStep < 2 || !adminSK) return;
            setStepState(3, 'running');
            const t0 = performance.now();
            try {
                const n = candidates.length;
                addLog(`[Step 3] 使用私钥解密 ${n} 组聚合密文...`, 'info');
                const results = [], resultPoints = [];
                for (let j = 0; j < n; j++) {
                    const mG = elgamal.decryptToPoint(tallyState.aggregated[j], adminSK);
                    resultPoints.push(mG);
                    const count = elgamal.solveDLog(mG, tallyState.numVotes + 100);
                    results.push(count);
                    addLog(`  ${candidates[j].name}: ${count} 票`, 'info');
                }
                tallyState.resultPoints = resultPoints;
                tallyState.results = results;
                // Render results
                const div = document.getElementById('tallyResults');
                div.innerHTML = '';
                results.forEach((r, i) => {
                    const item = document.createElement('div');
                    item.className = 'candidate-item';
                    item.innerHTML = `<span class="name">${escapeHtml(candidates[i].name)}</span><span class="votes">${r} 票</span>`;
                    div.appendChild(item);
                });
                const ms = fmtMs(performance.now() - t0);
                const summary = results.map((r, i) => `${candidates[i].name}:${r}`).join(', ');
                setStepDetail(3, `${summary} (${ms})`);
                setStepState(3, 'complete');
                tallyState.currentStep = 3;
                enableStep(4);
                addLog(`[Step 3] 解密完成, 耗时 ${ms}`, 'success');
            } catch (e) {
                setStepState(3, 'error');
                setStepDetail(3, `错误: ${escapeHtml(e.message)}`);
                addLog(`[Step 3] 失败: ${e.message}`, 'error');
            }
        }

        async function tallyStep4_generateZKP() {
            if (tallyState.currentStep < 3) return;
            setStepState(4, 'running');
            const t0 = performance.now();
            try {
                addLog('[Step 4] 正在生成 ZKP3 计票证明 (Groth16)...', 'info');
                addLog('  这可能需要 3-10 秒...', 'info');
                const G = elgamal.getGenerator();
                const derivedPK = elgamal.scalarMul(adminSK, G);
                const witness = elgamal.prepareTallyWitness(
                    adminSK, derivedPK, tallyState.aggregated,
                    tallyState.resultPoints, tallyState.numVotes
                );
                const { proof, publicSignals } = await snarkjs.groth16.fullProve(
                    witness,
                    CONTRACT_CONFIG.ZKP.TALLY_PROOF_WASM,
                    CONTRACT_CONFIG.ZKP.TALLY_PROOF_ZKEY
                );
                const calldataStr = await snarkjs.groth16.exportSolidityCallData(proof, publicSignals);
                const cd = JSON.parse(`[${calldataStr}]`);
                tallyState.proof = proof;
                tallyState.publicSignals = publicSignals;
                tallyState.pA = cd[0]; tallyState.pB = cd[1]; tallyState.pC = cd[2];
                tallyState.pubSignals15 = cd[3];
                const ms = fmtMs(performance.now() - t0);
                setStepDetail(4, `证明已生成 (${publicSignals.length} 公共信号, ${ms})`);
                setStepState(4, 'complete');
                tallyState.currentStep = 4;
                enableStep(5);
                addLog(`[Step 4] ZKP3 证明生成成功, 耗时 ${ms}`, 'success');
            } catch (e) {
                setStepState(4, 'error');
                setStepDetail(4, `错误: ${escapeHtml(e.message)}`);
                addLog(`[Step 4] 失败: ${e.message}`, 'error');
                console.error('ZKP error:', e);
            }
        }

        async function tallyStep5_buildMerkle() {
            if (tallyState.currentStep < 4) return;
            setStepState(5, 'running');
            const t0 = performance.now();
            try {
                addLog('[Step 5] 正在构建 Merkle 审计树...', 'info');
                const sorted = [...tallyState.events].sort((a, b) => {
                    const d = Number(a.blockNumber) - Number(b.blockNumber);
                    if (d !== 0) return d;
                    const t = Number(a.transactionIndex) - Number(b.transactionIndex);
                    if (t !== 0) return t;
                    return Number(a.logIndex) - Number(b.logIndex);
                });
                const net = await provider.getNetwork();
                const chainId = Number(net.chainId);
                const electionId = AuditLib.electionKey(chainId, VOTING_ADDRESS);
                const input = sorted.map(ev => ({
                    commitment: ev.args.commitment,
                    txHash: ev.transactionHash,
                    blockNumber: Number(ev.blockNumber),
                    logIndex: Number(ev.logIndex),
                }));
                const bundle = AuditLib.createAuditBundle(input, { chainId, electionId, votingAddress: VOTING_ADDRESS });
                tallyState.auditBundle = bundle;
                tallyState.merkleRoot = bundle.root;
                const ms = fmtMs(performance.now() - t0);
                setStepDetail(5, `Root: <span class="mono-data">${bundle.root.slice(0,18)}...</span> (${bundle.totalLeaves} 叶子, ${ms})`);
                setStepState(5, 'complete');
                tallyState.currentStep = 5;
                enableStep(6);
                addLog(`[Step 5] Merkle 树已构建: ${bundle.root.slice(0,18)}..., 耗时 ${ms}`, 'success');
            } catch (e) {
                setStepState(5, 'error');
                setStepDetail(5, `错误: ${escapeHtml(e.message)}`);
                addLog(`[Step 5] 失败: ${e.message}`, 'error');
            }
        }

        async function tallyStep6_submitChain() {
            if (tallyState.currentStep < 5) return;
            setStepState(6, 'running');
            const t0 = performance.now();
            try {
                // Check if already tallied (handles retry after lost connection)
                const info = await votingContract.getElectionInfo();
                if (Number(info[2]) === 3) {
                    addLog('[Step 6] 选举已处于已计票状态，跳过提交', 'warning');
                    setStepDetail(6, '选举已计票 (前次提交已成功)');
                    setStepState(6, 'complete');
                    tallyState.currentStep = 6;
                    enableStep(7);
                    return;
                }
                addLog('[Step 6] 提交计票结果上链 (含 ZKP3 证明)...', 'info');
                addLog('  请在 MetaMask 中确认交易', 'warning');
                const tx = await votingContract.updateTallyResults(
                    tallyState.results, tallyState.merkleRoot,
                    tallyState.pA, tallyState.pB, tallyState.pC, tallyState.pubSignals15
                );
                addLogHtml(`  交易已发送: ${txHashLink(tx.hash)}`, 'info');
                addLog('  等待区块确认...', 'info');
                const receipt = await tx.wait();
                tallyState.tallyTxHash = tx.hash;
                const ms = fmtMs(performance.now() - t0);
                setStepDetail(6, `已确认: ${txHashLink(tx.hash)} | 区块 ${receipt.blockNumber} | Gas ${receipt.gasUsed.toString()} (${ms})`);
                setStepState(6, 'complete');
                tallyState.currentStep = 6;
                enableStep(7);
                addLogHtml(`[Step 6] 上链成功: ${txHashLink(tx.hash)}, Gas: ${receipt.gasUsed.toString()}, 耗时 ${ms}`, 'success');
                await loadElectionInfo();
            } catch (e) {
                setStepState(6, 'error');
                setStepDetail(6, `错误: ${escapeHtml(e.message)}`);
                addLog(`[Step 6] 失败: ${e.message}`, 'error');
                console.error('Submit error:', e);
            }
        }

        function tallyStep7_exportAudit() {
            if (tallyState.currentStep < 6) return;
            setStepState(7, 'running');
            try {
                addLog('[Step 7] 正在生成审计包...', 'info');
                const electionId = tallyState.auditBundle.electionId;
                latestAuditBundle = {
                    ...tallyState.auditBundle,
                    tallyResults: tallyState.results,
                    tallyTxHash: tallyState.tallyTxHash,
                };
                localStorage.setItem('audit_bundle_' + electionId, JSON.stringify(latestAuditBundle));
                const shortAddr = VOTING_ADDRESS.slice(2, 10).toLowerCase();
                const fileName = `audit_bundle_${latestAuditBundle.chainId}_${shortAddr}.json`;
                downloadJsonFile(fileName, latestAuditBundle);
                setStepDetail(7, `已导出: ${fileName}`);
                setStepState(7, 'complete');
                tallyState.currentStep = 7;
                addLog(`[Step 7] 审计包已导出: ${fileName}`, 'success');
                addLog('全部 7 个计票步骤已完成。', 'success');
            } catch (e) {
                setStepState(7, 'error');
                setStepDetail(7, `错误: ${escapeHtml(e.message)}`);
                addLog(`[Step 7] 失败: ${e.message}`, 'error');
            }
        }

        window.addEventListener('load', async () => {
            addLog('管理员控制台已加载 (ZKP 版本)', 'info');
            try {
                elgamal = await ElGamalLib.init();
                addLog('ZKP 库初始化成功', 'success');
            } catch (e) {
                addLog(`ZKP 库初始化失败: ${e.message}`, 'error');
            }

            if (typeof window.ethereum !== 'undefined') {
                addLog('检测到 MetaMask', 'info');
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    addLog('发现已授权账户，自动连接...', 'info');
                    connectWallet();
                } else {
                    addLog('请点击连接钱包', 'info');
                }
            } else {
                addLog('未检测到 MetaMask，请安装: https://metamask.io', 'warning');
            }
        });
    </script>
</body>
</html>

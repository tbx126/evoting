<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员控制台 - 区块链电子投票系统 (ZKP)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&family=Fira+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #0F172A;
            --color-secondary: #1E293B;
            --color-cta: #22C55E;
            --color-background: #020617;
            --color-text: #F8FAFC;
            --color-muted: #94A3B8;
            --color-border: rgba(255,255,255,0.08);
            --color-surface: rgba(255,255,255,0.04);
            --color-surface-hover: rgba(255,255,255,0.07);
            --color-danger: #EF4444;
            --color-warning: #F59E0B;
            --color-info: #3B82F6;
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Fira Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.4;
        }
        /* --- Navbar --- */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 56px;
            background: var(--color-primary);
            border-bottom: 1px solid var(--color-border);
            z-index: 100;
            display: flex;
            align-items: center;
        }
        .nav-content {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
        }
        .nav-brand svg { flex-shrink: 0; }
        .zkp-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 20px;
            background: var(--color-cta);
            color: #fff;
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            font-weight: 600;
        }
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .subtitle {
            font-size: 13px;
            color: var(--color-muted);
            display: none;
        }
        .nav-link {
            color: var(--color-muted);
            text-decoration: none;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
            transition: all 200ms ease;
            cursor: pointer;
        }
        .nav-link:hover {
            color: var(--color-text);
            border-color: rgba(255,255,255,0.2);
            background: var(--color-surface);
        }
        .btn-sm {
            padding: 6px 14px;
            width: auto;
            border: none;
            border-radius: 8px;
            background: var(--color-cta);
            color: #fff;
            font-family: 'Fira Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-sm:hover { opacity: 0.9; }
        .btn-sm:disabled { background: #334155; color: #64748B; cursor: not-allowed; }
        .btn-sm.connected {
            background: rgba(34,197,94,0.15);
            color: var(--color-cta);
            border: 1px solid rgba(34,197,94,0.3);
            font-family: 'Fira Code', monospace;
            font-size: 12px;
        }
        .conn-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-danger);
            display: inline-block;
        }
        .conn-dot.connected { background: var(--color-cta); }
        /* --- Container --- */
        .app-layout {
            display: flex;
            margin-top: 56px;
            min-height: calc(100vh - 56px);
        }
        .container {
            flex: 1;
            min-width: 0;
            padding: 16px 24px 24px;
            overflow-y: auto;
            max-height: calc(100vh - 56px);
        }
        /* --- Stats Grid --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .stat-card {
            background: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 12px 16px;
            text-align: center;
            transition: transform 200ms ease, box-shadow 200ms ease;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .stat-label {
            font-size: 11px;
            color: var(--color-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .stat-val {
            font-family: 'Fira Code', monospace;
            font-size: 20px;
            font-weight: 600;
        }
        .stat-val.active { color: var(--color-cta); }
        .stat-val.warning { color: var(--color-warning); }
        /* --- Section --- */
        .section {
            background: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 20px;
        }
        .section-title {
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text);
        }
        .section-title svg { color: var(--color-cta); }
        .grid-2col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        /* --- Inputs --- */
        .input-group { margin-bottom: 10px; }
        .input-group label {
            display: block;
            font-size: 12px;
            color: var(--color-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            font-family: 'Fira Code', monospace;
            transition: border-color 200ms ease;
        }
        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--color-cta);
            box-shadow: 0 0 0 3px rgba(34,197,94,0.15);
        }
        .input-group input::placeholder, .input-group textarea::placeholder { color: #475569; }
        /* --- Buttons --- */
        .btn {
            width: 100%;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Fira Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms ease;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:last-child { margin-bottom: 0; }
        .btn-cta { background: var(--color-cta); color: #fff; }
        .btn-cta:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-success { background: #059669; color: #fff; }
        .btn-success:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-danger { background: var(--color-danger); color: #fff; }
        .btn-danger:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-warning { background: var(--color-warning); color: #000; }
        .btn-warning:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        /* --- Alerts --- */
        .alert {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert svg { flex-shrink: 0; }
        .alert-info {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.25);
            color: var(--color-info);
        }
        /* --- Candidate Items --- */
        .candidate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--color-surface);
            border-radius: 6px;
            margin-bottom: 4px;
        }
        .candidate-item .name { font-weight: 500; }
        .candidate-item .votes {
            color: var(--color-cta);
            font-family: 'Fira Code', monospace;
            font-weight: 600;
        }
        /* --- Loading --- */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* --- Log Sidebar --- */
        .log-sidebar {
            width: 360px;
            flex-shrink: 0;
            background: var(--color-primary);
            border-left: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 56px);
        }
        .log-sidebar-header {
            padding: 12px 16px;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .log-sidebar-header svg { color: var(--color-cta); }
        .log-body {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        .log-entry {
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            padding: 4px 16px;
            border-bottom: 1px solid var(--color-border);
            line-height: 1.5;
            word-break: break-all;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #64748B; }
        .log-info { color: var(--color-info); }
        .log-success { color: var(--color-cta); }
        .log-error { color: var(--color-danger); }
        .log-warning { color: var(--color-warning); }
        /* --- Responsive --- */
        @media (min-width: 769px) {
            .subtitle { display: inline; }
        }
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-2col { grid-template-columns: 1fr; }
            .app-layout { flex-direction: column; }
            .log-sidebar { width: 100%; max-height: 200px; border-left: none; border-top: 1px solid var(--color-border); }
            .container { max-height: none; }
        }
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .nav-content { padding: 0 16px; }
            .subtitle { display: none; }
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { transition: none !important; animation: none !important; }
        }
        /* --- Focus States --- */
        .btn:focus-visible, .btn-sm:focus-visible, .nav-link:focus-visible, .input-group input:focus-visible, .input-group textarea:focus-visible {
            outline: 2px solid var(--color-cta);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                管理员控制台
                <span class="zkp-badge">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    ZKP
                </span>
            </div>
            <div class="nav-actions">
                <span class="subtitle" id="adminSubtitle">区块链电子投票系统 - 零知识证明版</span>
                <a href="voting-app.html" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>
                    选民投票页
                </a>
                <button id="connectBtn" onclick="connectWallet()" class="btn-sm">
                    <span class="conn-dot" id="connectionDot"></span>
                    连接钱包
                </button>
            </div>
        </div>
    </nav>
    <div class="app-layout">
    <!-- Main Content -->
    <main class="container">
        <!-- Stats Row -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">当前状态</div>
                <div class="stat-val" id="electionStatus">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">候选人数</div>
                <div class="stat-val" id="candidateCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">已注册选民</div>
                <div class="stat-val" id="voterCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">已投票数</div>
                <div class="stat-val" id="voteCount">-</div>
            </div>
        </div>

        <!-- Management 2x2 Grid -->
        <div class="grid-2col">
            <!-- Top-left: 选举控制 -->
            <div class="section">
                <div class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    选举控制
                </div>
                <button class="btn btn-success" id="startBtn" onclick="startElection()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    启动选举
                </button>
                <button class="btn btn-danger" id="endBtn" onclick="endElection()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                    结束选举
                </button>
            </div>
            <!-- Top-right: 选民管理 -->
            <div class="section">
                <div class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                    选民管理
                </div>
                <div class="input-group">
                    <label>选民地址 (每行一个，支持批量)</label>
                    <textarea id="voterAddress" rows="2" placeholder="0x...&#10;0x..." style="resize:vertical;"></textarea>
                </div>
                <button class="btn btn-cta" id="registerBtn" onclick="registerVoters()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>
                    注册选民
                </button>
            </div>
            <!-- Bottom-left: 候选人管理 -->
            <div class="section">
                <div class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    候选人管理
                </div>
                <div class="input-group">
                    <label>候选人姓名</label>
                    <input type="text" id="candidateName" placeholder="输入候选人姓名" onkeydown="if(event.key==='Enter')addCandidate()" />
                </div>
                <button class="btn btn-cta" id="addCandidateBtn" onclick="addCandidate()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    添加候选人
                </button>
                <div id="candidateList" style="margin-top:8px;"></div>
            </div>
            <!-- Bottom-right: ElGamal 密钥管理 -->
            <div class="section">
                <div class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    ElGamal 密钥管理
                </div>
                <div class="alert alert-info">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    管理员需要输入 ElGamal 私钥用于解密投票结果
                </div>
                <div class="input-group">
                    <label>ElGamal 私钥 (sk)</label>
                    <input type="password" id="adminSK" placeholder="输入 ElGamal 私钥 (BigInt)" onkeydown="if(event.key==='Enter')loadAdminKey()" />
                </div>
                <button class="btn btn-cta" onclick="loadAdminKey()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                    加载密钥
                </button>
                <div id="keyStatus" style="margin-top:8px;font-size:12px;font-family:'Fira Code',monospace;color:var(--color-muted);"></div>
            </div>
        </div>
        <!-- ZKP Tally Section -->
        <div class="section" id="tallySection">
            <div class="section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                ZKP 计票管理
            </div>
            <div class="alert alert-info">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                计票流程: 结束选举 → 读取加密选票 → 同态聚合 → 解密 → 生成 ZKP3 证明 → 上传结果
            </div>
            <button class="btn btn-warning" id="tallyBtn" onclick="submitTallyWithZKP()" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                同态计票 + 生成 ZKP3 证明
            </button>
            <div id="tallyResults" style="margin-top:12px;"></div>
        </div>
    </main>

    <!-- Log Sidebar -->
    <aside class="log-sidebar" id="logPanel">
        <div class="log-sidebar-header">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
            操作日志
        </div>
        <div class="log-body" id="logBody"></div>
    </aside>
    </div>

    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/snarkjs@0.7.3/build/snarkjs.min.js"></script>
    <script src="lib/circomlibjs.bundle.js"></script>
    <script src="config.js"></script>
    <script src="lib/elgamal.js"></script>
    <script>
        const VOTING_ADDRESS = CONTRACT_CONFIG.VOTING_ADDRESS;
        const VOTER_REGISTRY_ADDRESS = CONTRACT_CONFIG.VOTER_REGISTRY_ADDRESS;

        const VOTING_ABI = [
            "function getElectionInfo() view returns (string, string, uint8, uint256, uint256)",
            "function getCandidate(uint256) view returns (string, uint256)",
            "function addCandidate(string)",
            "function startElection()",
            "function endElection()",
            "function updateTallyResults(uint256[], bytes32, uint256[2], uint256[2][2], uint256[2], uint256[21])",
            "function admin() view returns (address)",
            "function getElgamalPK() view returns (uint256[2])",
            "event EncryptedVoteCast(address indexed voter, bytes32 commitment, uint256[] encryptedVote)"
        ];
        const VOTER_REGISTRY_ABI = [
            "function registerVoter(address)",
            "function registerVotersBatch(address[])",
            "function isRegistered(address) view returns (bool)",
            "function hasVoted(address) view returns (bool)",
            "function totalVoters() view returns (uint256)",
            "function admin() view returns (address)"
        ];

        let provider, signer, votingContract, voterRegistryContract, currentAccount;
        let candidates = [];
        let elgamal = null;
        let adminSK = null;
        let adminPK = null;
        const STATUS_NAMES = ["已创建", "进行中", "已结束", "已计票"];

        function addLog(message, type = 'info') {
            const logBody = document.getElementById('logBody');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logBody.appendChild(entry);
            logBody.scrollTop = logBody.scrollHeight;
        }

        function loadAdminKey() {
            const skInput = document.getElementById('adminSK').value.trim();
            if (!skInput) { addLog('请输入 ElGamal 私钥', 'warning'); return; }
            try {
                adminSK = BigInt(skInput);
                const G = elgamal.getGenerator();
                const derivedPK = elgamal.scalarMul(adminSK, G);
                document.getElementById('keyStatus').textContent =
                    `密钥已加载 (PK.x: ${elgamal.fromF(derivedPK[0]).toString().slice(0, 20)}...)`;
                document.getElementById('keyStatus').style.color = 'var(--color-cta)';
                addLog('ElGamal 私钥已加载', 'success');
            } catch (e) {
                addLog(`密钥加载失败: ${e.message}`, 'error');
                document.getElementById('keyStatus').textContent = '密钥格式错误';
                document.getElementById('keyStatus').style.color = 'var(--color-danger)';
            }
        }
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                addLog('请安装 MetaMask！', 'error'); return;
            }
            try {
                addLog('正在连接钱包...', 'info');
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                currentAccount = accounts[0];

                const network = await provider.getNetwork();
                const expectedChainId = BigInt(CONTRACT_CONFIG.NETWORK.chainId);
                if (network.chainId !== expectedChainId) {
                    addLog(`请切换到 ${CONTRACT_CONFIG.NETWORK.name} 网络`, 'warning');
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CONTRACT_CONFIG.NETWORK.chainIdHex }] });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{ chainId: CONTRACT_CONFIG.NETWORK.chainIdHex, chainName: CONTRACT_CONFIG.NETWORK.name,
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: [CONTRACT_CONFIG.NETWORK.rpcUrl || 'https://rpc.sepolia.org'],
                                    blockExplorerUrls: [CONTRACT_CONFIG.NETWORK.explorerUrl || 'https://sepolia.etherscan.io'] }]
                            });
                        } else { throw switchError; }
                    }
                    provider = new ethers.BrowserProvider(window.ethereum);
                }

                signer = await provider.getSigner();
                votingContract = new ethers.Contract(VOTING_ADDRESS, VOTING_ABI, signer);
                voterRegistryContract = new ethers.Contract(VOTER_REGISTRY_ADDRESS, VOTER_REGISTRY_ABI, signer);

                const votingAdmin = await votingContract.admin();
                if (votingAdmin.toLowerCase() !== currentAccount.toLowerCase()) {
                    addLog('当前账户不是管理员！', 'warning');
                    addLog(`管理员地址: ${votingAdmin}`, 'info');
                }

                try {
                    const pk = await votingContract.getElgamalPK();
                    adminPK = elgamal.pkFromBigInts(pk[0].toString(), pk[1].toString());
                    addLog('已加载 ElGamal 公钥', 'success');
                } catch (e) {
                    adminPK = elgamal.pkFromBigInts(CONTRACT_CONFIG.ELGAMAL_PK.x, CONTRACT_CONFIG.ELGAMAL_PK.y);
                    addLog('使用配置中的 ElGamal 公钥', 'info');
                }

                document.getElementById('connectionDot').classList.add('connected');
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.innerHTML = `<span class="conn-dot connected"></span> 已连接`;
                connectBtn.classList.add('connected');
                connectBtn.disabled = true;
                document.getElementById('adminSubtitle').textContent =
                    `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)} | ${CONTRACT_CONFIG.NETWORK.name}`;

                if (CONTRACT_CONFIG.DEV_ADMIN_SK) {
                    document.getElementById('adminSK').value = CONTRACT_CONFIG.DEV_ADMIN_SK;
                    addLog('检测到开发模式，已自动填充测试 ElGamal 私钥', 'warning');
                }

                addLog(`已连接: ${currentAccount.slice(0, 10)}...`, 'success');
                await loadElectionInfo();
                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            } catch (error) {
                if (error.code === 4001) { addLog('用户拒绝了连接请求', 'warning'); }
                else { addLog(`连接失败: ${error.message}`, 'error'); }
            }
        }
        async function loadElectionInfo() {
            try {
                const info = await votingContract.getElectionInfo();
                const status = Number(info[2]);
                const candidateCount = Number(info[3]);
                const totalVotes = Number(info[4]);
                const totalVoters = await voterRegistryContract.totalVoters();

                const statusEl = document.getElementById('electionStatus');
                statusEl.textContent = STATUS_NAMES[status];
                statusEl.className = 'stat-val' + (status === 1 ? ' active' : status === 0 ? ' warning' : '');
                document.getElementById('candidateCount').textContent = candidateCount;
                document.getElementById('voterCount').textContent = totalVoters.toString();
                document.getElementById('voteCount').textContent = totalVotes;

                document.getElementById('startBtn').disabled = status !== 0;
                document.getElementById('endBtn').disabled = status !== 1;
                document.getElementById('addCandidateBtn').disabled = status !== 0;
                document.getElementById('registerBtn').disabled = false;
                document.getElementById('tallyBtn').disabled = status !== 2;

                candidates = [];
                const candidateList = document.getElementById('candidateList');
                candidateList.innerHTML = '';
                for (let i = 0; i < candidateCount; i++) {
                    const candidate = await votingContract.getCandidate(i);
                    candidates.push({ id: i, name: candidate[0], votes: Number(candidate[1]) });
                    candidateList.innerHTML += `<div class="candidate-item"><span class="name">${candidate[0]}</span><span class="votes">${candidate[1]} 票</span></div>`;
                }
                addLog('选举信息已加载', 'success');
            } catch (error) {
                addLog(`加载失败: ${error.message}`, 'error');
            }
        }

        async function registerVoters() {
            const raw = document.getElementById('voterAddress').value.trim();
            if (!raw) { addLog('请输入选民地址', 'warning'); return; }

            const addresses = raw.split(/[\n,;]+/).map(a => a.trim()).filter(a => a.startsWith('0x') && a.length === 42);
            if (addresses.length === 0) { addLog('未找到有效的以太坊地址', 'warning'); return; }

            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 注册中...';

            try {
                if (addresses.length === 1) {
                    const addr = addresses[0];
                    const isRegistered = await voterRegistryContract.isRegistered(addr);
                    if (isRegistered) { addLog(`${addr.slice(0,10)}... 已注册`, 'warning'); }
                    else {
                        addLog(`正在注册选民: ${addr.slice(0, 10)}...`, 'info');
                        const tx = await voterRegistryContract.registerVoter(addr);
                        addLog('等待交易确认...', 'info');
                        await tx.wait();
                        addLog('选民注册成功！', 'success');
                    }
                } else {
                    addLog(`批量注册 ${addresses.length} 个选民...`, 'info');
                    const tx = await voterRegistryContract.registerVotersBatch(addresses);
                    addLog('等待交易确认...', 'info');
                    await tx.wait();
                    addLog(`${addresses.length} 个选民注册成功！`, 'success');
                }
                document.getElementById('voterAddress').value = '';
                await loadElectionInfo();
            } catch (error) {
                addLog(`注册失败: ${error.message}`, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '注册选民';
        }
        async function addCandidate() {
            const name = document.getElementById('candidateName').value.trim();
            if (!name) { addLog('请输入候选人姓名', 'warning'); return; }
            const btn = document.getElementById('addCandidateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 添加中...';
            try {
                addLog(`正在添加候选人: ${name}`, 'info');
                const tx = await votingContract.addCandidate(name);
                addLog('等待交易确认...', 'info');
                await tx.wait();
                addLog('候选人添加成功！', 'success');
                document.getElementById('candidateName').value = '';
                await loadElectionInfo();
            } catch (error) {
                addLog(`添加失败: ${error.message}`, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '添加候选人';
        }

        async function startElection() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 启动中...';
            try {
                addLog('正在启动选举...', 'info');
                const tx = await votingContract.startElection();
                addLog('等待交易确认...', 'info');
                await tx.wait();
                addLog('选举已启动！', 'success');
                await loadElectionInfo();
            } catch (error) {
                addLog(`启动失败: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '启动选举';
            }
        }

        async function endElection() {
            if (!confirm('确定要结束选举吗？')) return;
            const btn = document.getElementById('endBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 结束中...';
            try {
                addLog('正在结束选举...', 'info');
                const tx = await votingContract.endElection();
                addLog('等待交易确认...', 'info');
                await tx.wait();
                addLog('选举已结束！', 'success');
                await loadElectionInfo();
            } catch (error) {
                addLog(`结束失败: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '结束选举';
            }
        }
        async function submitTallyWithZKP() {
            if (!adminSK) { addLog('请先加载 ElGamal 私钥', 'error'); return; }
            const btn = document.getElementById('tallyBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 读取加密选票...';
            const numCandidates = candidates.length;

            try {
                addLog('正在读取链上加密选票事件...', 'info');
                const filter = votingContract.filters.EncryptedVoteCast();
                const events = await votingContract.queryFilter(filter);
                addLog(`找到 ${events.length} 张加密选票`, 'info');

                if (events.length === 0) {
                    addLog('没有投票记录', 'warning');
                    btn.disabled = false;
                    btn.innerHTML = '同态计票 + 生成 ZKP3 证明';
                    return;
                }

                addLog('正在执行同态聚合...', 'info');
                btn.innerHTML = '<span class="loading"></span> 同态聚合中...';

                const allVotes = events.map(event => {
                    const encData = event.args.encryptedVote;
                    return elgamal.uint256ArrayToCiphertexts(
                        encData.map(x => BigInt(x.toString())), numCandidates
                    );
                });

                const aggregated = elgamal.aggregateVotes(allVotes, numCandidates);
                addLog('同态聚合完成', 'success');

                addLog('正在解密投票结果...', 'info');
                btn.innerHTML = '<span class="loading"></span> 解密中...';

                const results = [];
                const resultPoints = [];
                for (let j = 0; j < numCandidates; j++) {
                    const mG = elgamal.decryptToPoint(aggregated[j], adminSK);
                    resultPoints.push(mG);
                    const count = elgamal.solveDLog(mG, events.length + 100);
                    results.push(count);
                    addLog(`${candidates[j].name}: ${count} 票`, 'info');
                }

                const tallyResultsDiv = document.getElementById('tallyResults');
                tallyResultsDiv.innerHTML = results.map((r, i) =>
                    `<div class="candidate-item"><span class="name">${candidates[i].name}</span><span class="votes">${r} 票</span></div>`
                ).join('');
                addLog('正在生成 ZKP3 计票证明 (Groth16)...', 'info');
                btn.innerHTML = '<span class="loading"></span> ZKP3 证明生成中...';

                const G = elgamal.getGenerator();
                const derivedPK = elgamal.scalarMul(adminSK, G);
                const tallyWitness = elgamal.prepareTallyWitness(
                    adminSK, derivedPK, aggregated, resultPoints, events.length
                );

                const { proof, publicSignals } = await snarkjs.groth16.fullProve(
                    tallyWitness,
                    CONTRACT_CONFIG.ZKP.TALLY_PROOF_WASM,
                    CONTRACT_CONFIG.ZKP.TALLY_PROOF_ZKEY
                );
                addLog('ZKP3 证明生成成功!', 'success');

                const calldataStr = await snarkjs.groth16.exportSolidityCallData(proof, publicSignals);
                const calldata = JSON.parse(`[${calldataStr}]`);
                const pA = calldata[0], pB = calldata[1], pC = calldata[2];
                const pubSignals21 = calldata[3];

                const merkleRoot = ethers.keccak256(ethers.toUtf8Bytes(JSON.stringify(results)));

                addLog('正在提交计票结果 (含 ZKP3 证明)...', 'info');
                btn.innerHTML = '<span class="loading"></span> 提交中...';

                const tx = await votingContract.updateTallyResults(
                    results, merkleRoot, pA, pB, pC, pubSignals21
                );
                addLog('交易已发送，等待确认...', 'info');
                await tx.wait();

                addLog('计票结果已上传并通过 ZKP 验证!', 'success');
                await loadElectionInfo();
            } catch (error) {
                addLog(`计票失败: ${error.message}`, 'error');
                console.error('Tally error:', error);
                btn.disabled = false;
                btn.innerHTML = '同态计票 + 生成 ZKP3 证明';
            }
        }

        window.addEventListener('load', async () => {
            addLog('管理员控制台已加载 (ZKP 版本)', 'info');
            try {
                elgamal = await ElGamalLib.init();
                addLog('ZKP 库初始化成功', 'success');
            } catch (e) {
                addLog(`ZKP 库初始化失败: ${e.message}`, 'error');
            }

            if (typeof window.ethereum !== 'undefined') {
                addLog('检测到 MetaMask', 'info');
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    addLog('发现已授权账户，自动连接...', 'info');
                    connectWallet();
                } else {
                    addLog('请点击连接钱包', 'info');
                }
            } else {
                addLog('未检测到 MetaMask，请安装: https://metamask.io', 'warning');
            }
        });
    </script>
</body>
</html>
